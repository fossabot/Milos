<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Milos - Image Upload</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="/static/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="/static/ajax/libs/ionicons/4.5.6/css/ionicons.min.css">
    <link rel="stylesheet" href="/static/assets/css/notifyme.css?version=1565771136">
    <link rel="stylesheet" href="/static/assets/css/indexstyle.css?version=15657711361">
    

    <!-- Load google font-->
    <link rel="stylesheet" href="/static/fonts/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic"  media="none" onload="if(media!='all')media='all'">

    <script src="/static/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">Milos</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/about">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/contact">Contact</a>
                </li>
            </ul>
            <ul class="navbar-nav navbar-right">
                <li class="nav-item">
                    <a class="nav-link" href="/changelog">Change Log</a>
                </li>
<!--                 <li class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" id="drop_api" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">API <span class="caret"></span></a>
                    <div class="dropdown-menu" aria-labelledby="drop_api">
                        <a class="dropdown-item" href="https://sm.ms/doc/v1">V1</a>
                        <a class="dropdown-item" href="https://sm.ms/doc/v2">V2</a>
                    </div>
                </li> -->
<!--                 <li class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" id="drop_user" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">User <span class="caret"></span></a>
                    <div class="dropdown-menu" aria-labelledby="drop_user">
                                                    <a class="dropdown-item" href="https://sm.ms/login">Login</a>
                                                        <a class="dropdown-item" href="https://sm.ms/register">Register</a>
                                                                        </div>
                </li> -->
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>

<!-- Content Wrapper. Contains page content -->
<div class="container kv-main">
    
    <div class="page-header">
        <h1>Image Upload</h1> 50 MB max per file. 10 files max per request.
    </div>
    <form enctype="multipart/form-data">
        <div class="form-group" style="max-height: 2000px;">
            <input id="smfile" type="file" multiple class="file" data-overwrite-initial="false" data-min-file-count="1" name="smfile" accept="image/*">
        </div>
    </form>
    <form id="upload_option" enctype="multipart/form-data">
            </form>
    <div id="showurl" style="display: none;">
        <ul id="navTab" class="nav nav-tabs" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="imagedetail-tab"  href="#imagedetail" data-toggle="tab">Preview</a></li>
            <li class="nav-item"><a class="nav-link" id="bbcodePanel-tab" href="#bbcodePanel" data-toggle="tab">BBCode</a></li>
            <li class="nav-item"><a class="nav-link" id="htmlcodePanel-tab" href="#htmlcodePanel" data-toggle="tab">HTML</a></li>
            <li class="nav-item"><a class="nav-link" id="urlcodePanel-tab" href="#urlcodePanel" data-toggle="tab">Image URL</a></li>
            <li class="nav-item"><a class="nav-link" id="linkPanel-tab" href="#linkPanel" data-toggle="tab">Page Link</a></li>
            <li class="nav-item"><a class="nav-link" id="markdownPanel-tab" href="#markdownPanel" data-toggle="tab">Markdown</a></li>
            <li class="nav-item"><a class="nav-link" id="removePanel-tab" href="#removePanel" data-toggle="tab">Remove Link</a></li>
        </ul>
        <div id="navTabContent" class="tab-content" style="border:none;">
            <div class="tab-pane fade show active" id="imagedetail" role="tabpanel" aria-labelledby="imagedetail-tab"></div>
            <div class="tab-pane fade" id="bbcodePanel" role="tabpanel" aria-labelledby="bbcodePanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="bbcode"></code></pre>
            </div>
            <div class="tab-pane fade" id="htmlcodePanel" role="tabpanel" aria-labelledby="htmlcodePanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="htmlcode"></code></pre>
            </div>
            <div class="tab-pane fade" id="urlcodePanel" role="tabpanel" aria-labelledby="urlcodePanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="urlcode"></code></pre>
            </div>
            <div class="tab-pane fade" id="linkPanel" role="tabpanel" aria-labelledby="linkPanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="linkcode"></code></pre>
            </div>
            <div class="tab-pane fade" id="markdownPanel" role="tabpanel" aria-labelledby="markdownPanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="markdown"></code></pre>
            </div>
            <div class="tab-pane fade" id="removePanel" role="tabpanel" aria-labelledby="removePanel-tab">
                <pre onclick="clip(this);" style="margin-top: 5px;"><code id="removelink"></code></pre>
            </div>
        </div>
    </div>
    <!-- /.content-wrapper -->

</div>
<!-- /.content-wrapper -->

<footer class="footer">
    <div class="container">
        <p class="text-muted">Copyright &#9400; 2019 ， <a
            href="https://github.com/coolrc136/Milos" target="_blank">Milos</a> all rights
        reserved. </p>
    </div>
</footer>

<!-- js -->
<script src="/static/ajax/libs/twitter-bootstrap/4.2.1/js/bootstrap.min.js"></script>
<script src="/static/ajax/libs/layer/2.3/layer.js"></script>
<script src="/static/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script src="/static/assets/js/notifyme.js"></script>


    <link href="/static/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <link href="/static/assets/css/lib/fontawesome/css/all.min.css" media="all" rel="stylesheet" type="text/css" />

    <!-- DataTables -->
    <script src="/static/ajax/libs/datatables/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="/static/ajax/libs/datatables/1.10.16/js/dataTables.bootstrap.min.js"></script>
    <!-- Layer -->
    <script src="/static/ajax/libs/layer/2.3/layer.js"></script>
    <!-- Lazyload -->
    <script src="/static/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js" type="text/javascript"></script>
    <!-- fileinput  -->
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js" type="text/javascript"></script>
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/sortable.min.js" type="text/javascript"></script>
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/purify.min.js" type="text/javascript"></script>
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js" type="text/javascript"></script>
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/themes/fas/theme.min.js"></script>
    <script src="/static/ajax/libs/bootstrap-fileinput/4.5.1/js/locales/zh.js" type="text/javascript"></script>
    <script src="/static/ajax/libs/dompurify/1.0.10/purify.min.js" type="text/javascript"></script>

    <script src="/static/ajax/libs/handlebars.js/4.1.2/handlebars.min.js" type="text/javascript"></script>

    
    <script id="image-template" type="text/x-handlebars-template">
        <fieldset style="margin-top: 10px;">
            <legend><img src="/static/assets/images/icons/photo.png" alt="" style="vertical-align:middle; line-height:16px; height:16px; padding-right:5px;">{{filename}}</legend>
            <table style="width:100%;">
                <tbody><tr>
                    <td style="width:260px; text-align: center;">
                        <a href="{{page}}" target="_blank">
                            <img class="lazy" onload="DrawImage(this, 260, 260)" width="{{width}}" height="{{height}}" src="{{url}}" style="max-width: 300px;max-height: 300px;">
                        </a>
                    </td>
                    <td class="padding10" style="text-align:left;">
                        <div class="dlinput_header">HTML</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="<a href=&quot;{{page}}&quot; target=&quot;_blank&quot;><img src=&quot;{{url}}&quot; ></a>">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">BBCode</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="[url={{page}}][img]{{url}}[/img][/url]">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">Markdown</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="![{{filename}}]({{url}})">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">Link only</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="{{page}}">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">Removal Link (to delete the image)</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="{{delete}}">
                                </div>
                            </div>
                        </div>
                    </td>
                </tr></tbody>
            </table>
        </fieldset>
    </script>
    

    <script>
    let $smfile = $("#smfile");
    $smfile.fileinput({
        theme: "fas",
        uploadUrl: '/',
        uploadExtraData: function (previewId, index) {
            var dataArray = $("#upload_option").serializeArray(),
                len = dataArray.length,
                dataObj = { };

            for (let i=0; i<len; i++) {
                dataObj[dataArray[i].name] = dataArray[i].value;
            }
            return dataObj;
        },
        allowedFileExtensions : ['jpeg','jpg','png','gif','bmp'],
        overwriteInitial: false,
        previewFileType: "image",
        maxFileSize: '51200',
        maxFileCount: '100',
        autoOrientImage: true,
        fileActionSettings: {
            showRemove: true,
            showUpload: false,
            showZoom: true,
            showDrag: true,
        },
        browseClass: "btn btn-success",
        browseLabel: "Select Image(s)",
        browseIcon: "<i class=\"fas fa-images\"></i> ",
        removeClass: "btn btn-danger",
        removeLabel: "Clear",
        uploadClass: "btn btn-info",
        uploadLabel: "Upload",
        dropZoneTitle: "Drag & drop files here ...<br>or<br>Copy & paste screenshots here ..."
    });

    function hasHtmlTags(string) {
        var pattern = /<(.*)>/;
        console.log(pattern.test(string));
        return pattern.test(string);
    }

    $smfile.on('fileselect', function(event, numFiles, label) {
        var files = $('#smfile').fileinput('getFileStack');
        $.each(files, function( index, blob ) {
            if (hasHtmlTags(blob.name)) {
                let filename = DOMPurify.sanitize(blob.name);
                filename = filename.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const myNewFile = new File([blob], filename, { type: blob.type });
                $smfile.fileinput('updateStack', index, myNewFile);
            }
        });
    });
    var clip = function(el) {
        var range = document.createRange();
        range.selectNodeContents(el);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    };
    
    document.addEventListener('paste', function (event) {
        var isChrome = false;
        if ( event.clipboardData || event.originalEvent ) {
            var clipboardData = (event.clipboardData || event.originalEvent.clipboardData);
            if ( clipboardData.items ) {
                // for chrome
                var  items = clipboardData.items,
                    len = items.length,
                    blob = null;
                isChrome = true;
    
                event.preventDefault();
    
                let images = [];
                for (var i = 0; i < len; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        blob = items[i].getAsFile();
                        images.push(blob);
                    }
                }
                if(images.length > 0) {
                    uploadBlobFile(images);
                }
                if ( blob !== null ) {
                    let reader = new FileReader();
                    reader.onload = function (event) {
                        let base64_str = event.target.result;
                    }
    
                }
            } else {
                //for firefox
            }
        } else {
        }
    });
    
    function uploadBlobFile(images) {
        let form = $("#smfile");
        swal({
            title: "提醒",
            text: "是否上传粘贴的图片?",
            icon: "warning",
            dangerMode: true,
            buttons: {
                cancel: {
                    text: "Cancel",
                    visible: true,
                    closeModal: true,
                },
                confirm: {
                    text: "OK",
                    value: true,
                    visible: true,
                    closeModal: true
                }
            }
        }).then(function (willUpload) {
            if (willUpload) {
                $.each(images, function( index, blob ) {
                    $(form).fileinput('addToStack', blob);
                    $(form).fileinput('readFiles', blob);
                });
                $(form).fileinput('upload');
            }
        });
    }
        
    function DrawImage(ImgD,FitWidth,FitHeight){
        var image=new Image();
        image.src=ImgD.src;
        if(image.width>0 && image.height>0){
            if(image.width <= 260 && image.height <=260) {
                return;
            }
            if(image.width/image.height>= FitWidth/FitHeight){
                if(image.width>FitWidth){
                    ImgD.width=FitWidth;
                    ImgD.height=(image.height*FitWidth)/image.width;
                }else{
                    ImgD.width=image.width;
                    ImgD.height=image.height;
                }
            } else{
                if(image.height>FitHeight){
                    ImgD.height=FitHeight;
                    ImgD.width=(image.width*FitHeight)/image.height;
                }else{
                    ImgD.width=image.width;
                    ImgD.height=image.height;
                }
            }
        }
    }
    function formatHtml(data) {
        tpl = $('#image-template').html();
        template = Handlebars.compile(tpl);
        return template(data);
    }

    $smfile.on('fileuploaded', function(event, data, previewId, index) {
        var form = data.form, files = data.files, extra = data.extra, response = data.response, reader = data.reader;
        if(response.code === 'success') {
            if($('#showurl').html()) {
                $("#showurl").show();
            }
            $('#imagedetail').append(formatHtml(response.data));
            $('#urlcode').append(response.data.url + "\n");
            $('#linkcode').append(response.data.page + "\n");
            $('#htmlcode').append("&lt;a href=\""+ response.data.page  +"\" target=\"_blank\"&gt;&lt;img src=\""+ (response.data.thumb == null ? response.data.url : response.data.thumb.url) +"\" /&gt;&lt;/a&gt;" + "\n");
            $('#bbcode').append("[url="+response.data.page+"][img]"+ (response.data.thumb == null ? response.data.url : response.data.thumb.url) +"[/img][/url]" + "\n");
            $('#markdown').append("!["+ files[index].name +"](" + (response.data.thumb == null ? response.data.url : response.data.thumb.url) + ")" + "\n");
            $('#removelink').append(window.location.href + response.data.delete + "\n");
            
        }
    });
    $smfile.on('filecleared', function(event) {
        if($("#showurl").is(":visible")) {
            layer.confirm('是否要清空历史上传', {
                btn: ['Yes', 'No'] //按钮
            }, function(index){
                $('#imagedetail').html("");
                $('#urlcode').html("");
                $('#linkcode').html("");
                $('#htmlcode').html("");
                $('#bbcode').html("");
                $('#markdown').html("");
                $('#removelink').html("");
                $("#showurl").hide();
                layer.close(index);
            }, function(){
            });
        }
    });

    $smfile.on('filebatchuploadcomplete', function(event, files, extra) {
        $('img.lazy').lazyload();
    });
</script>

</body>
</html>